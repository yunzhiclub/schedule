name: Ng Test and Build
env:
  NODE_VERSION: '14.15.4'
  PROJECT_NAME: 'schedule'
  JAVA_VERSION: '8.0.312+7'                  # set this to the Java version to use
  DISTRIBUTION: adopt                  # set this to the Java distribution
  
on: [push, pull_request]

jobs:
  angular:
    runs-on: ubuntu-22.04

    steps:
    - name: Cancel Previous Runs
      uses: styfle/cancel-workflow-action@0.11.0
      with:
        access_token: ${{ github.token }}
        
    - name: checkout
      uses: actions/checkout@v3
    
    - name: Setup Node.js environment
      uses: actions/setup-node@v3.5.1
      with: 
        node-version: ${{ env.NODE_VERSION }}
        cache: npm
        cache-dependency-path: schedule/package.json
    
    
        
    - name: print env 
      run: printenv
      
    - name: npm install
      run: |
        cd ${{ env.PROJECT_NAME }}
        npm install --no-optional  --no-package-lock
        node_modules/@angular/cli/bin/ng --version
        
    - name: ng lint
      run: |
        cd ${{ env.PROJECT_NAME }} 
        node_modules/@angular/cli/bin/ng lint
      
    - name: ng test
      run: cd ${{ env.PROJECT_NAME }} && node_modules/@angular/cli/bin/ng test --watch=false --browsers=ChromeHeadless --sourceMap=false    
      
    - name: ng build
      run: cd ${{ env.PROJECT_NAME }} && node_modules/@angular/cli/bin/ng build --prod

  springBoot:
    runs-on: ubuntu-22.04
    steps:
    - name: Cancel Previous Runs
      uses: styfle/cancel-workflow-action@0.7.0
      with:
        access_token: ${{ github.token }}
        
    - name: checkout
      uses: actions/checkout@v3
      
    - name: build mysql
      run: |
          docker pull mysql:5.7
          docker run -p 3310:3306 -e MYSQL_ROOT_PASSWORD=root -e MYSQL_DATABASE=schedule -d mysql:5.7 --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
      
    - name: Set up JDK 1.8
      uses: actions/setup-java@v3.0.0
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: ${{ env.DISTRIBUTION }}
        cache: 'maven'
      
#     - name: Setup MySQL
#       uses: mirromutth/mysql-action@v1.1
#       with:
#         host port: 3310 # Optional, default value is 3306. The port of host
#         container port: 3306 # Optional, default value is 3306. The port of container
#         character set server: 'utf8mb4'
#         collation server: 'utf8_general_ci'
#         mysql version: 5.7
#         mysql database: schedule
#         mysql user: root
#         mysql password: root
        
    - name: print env
      run: printenv
      
    - name: cat $GITHUB_EVENT_PATH
      run: cat $GITHUB_EVENT_PATH
      
    - name: Build with Maven
      run: cd api && mvn install
    

  notify:

    runs-on: ubuntu-latest
    needs: [angular, springBoot]
    steps:

    - name: set PR_NUMBER
      if: ${{ always() }}
      run: |
        cd api
        echo PR_NUMBER=$(echo $GITHUB_REF | awk 'BEGIN { FS = "/" } ; { print $3 }') >> $GITHUB_ENV
        echo PR_TITLE=$(jq --raw-output .pull_request.title "$GITHUB_EVENT_PATH") >> $GITHUB_ENV
        echo PR_URL=$(jq --raw-output .pull_request._links.html.href "$GITHUB_EVENT_PATH") >> $GITHUB_ENV
        echo PR_USER=$(jq --raw-output .pull_request.user.login "$GITHUB_EVENT_PATH") >> $GITHUB_ENV
        echo YZ_DESCRIPTION=$(jq --raw-output .repository.description "$GITHUB_EVENT_PATH") >> $GITHUB_ENV
        echo YZ_HTML_URL=$(jq --raw-output .repository.html_url "$GITHUB_EVENT_PATH") >> $GITHUB_ENV
        
    - name: angular build failure
      if: ${{ failure() }}
      uses: fifsky/dingtalk-action@master
      with:
        url: https://oapi.dingtalk.com/robot/send?access_token=39f9e04938c553ab8609fd6eeac65ef11a28d2631fe27d1525edffbd3b5d9013
        type: markdown
        content: |
          # ðŸ’¤ðŸ¤·â€â™€ï¸  Failure ðŸ’£ðŸ’£ðŸ’£
          > Angular Build of [#${{ env.PR_NUMBER }} ${{ env.PR_TITLE }}](${{ env.PR_URL }}) of [${{ env.YZ_DESCRIPTION }}](${{ env.YZ_HTML_URL }}) by ${{ env.PR_USER }} failure
    - name: angular build success 
      if: ${{ success() }}
      uses: fifsky/dingtalk-action@master
      with:
        url: https://oapi.dingtalk.com/robot/send?access_token=39f9e04938c553ab8609fd6eeac65ef11a28d2631fe27d1525edffbd3b5d9013
        type: markdown
        content: |
          # ðŸ’¯ðŸ‘¨â€ðŸ’»  Success ðŸŽˆðŸŽˆðŸŽˆ
          > Angular Build [#${{ env.PR_NUMBER }} ${{ env.PR_TITLE }}](${{ env.PR_URL }}) of [${{ env.YZ_DESCRIPTION }}](${{ env.YZ_HTML_URL }}) by ${{ env.PR_USER }} success
